# .github/workflows/secure-rdp.yml
name: secure-rdp

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # optional: run every 6 hours

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    - name: Configure RDP (registry + firewall)
      shell: powershell
      run: |
        Write-Host "--- Configure RDP registry and firewall ---"
        # enable Remote Desktop
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0 -Force

        # optional: relax NLA/SecurityLayer for compatibility
        try {
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -Value 0 -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'SecurityLayer' -Value 0 -Force -ErrorAction SilentlyContinue
        } catch { Write-Warning "Could not change RDP-Tcp keys: $_" }

        # remove existing rule (ignore if not present)
        netsh advfirewall firewall delete rule name="RDP-Tailscale" > $null 2>&1
        # add firewall rule for RDP
        netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 > $null 2>&1

        # restart service to apply changes
        Restart-Service -Name TermService -Force -ErrorAction SilentlyContinue
        Write-Host "RDP configuration finished."

    - name: Create (or ensure) RDP local user and groups
      shell: powershell
      run: |
        Write-Host "--- Create / Ensure local user 'RDP' ---"
        $userName = "RDP"
        $passwordPlain = $null

        $exists = Get-LocalUser -Name $userName -ErrorAction SilentlyContinue
        if ($null -ne $exists) {
          Write-Host "User '$userName' already exists."
        } else {
          # generate a 16-char password (mix of categories)
          $chars = (65..90) + (97..122) + (48..57) + (33..47) + (58..64)
          $pwdChars = for ($i = 0; $i -lt 16; $i++) { [char](Get-Random -InputObject $chars) }
          $passwordPlain = -join $pwdChars

          try {
            $securePass = ConvertTo-SecureString $passwordPlain -AsPlainText -Force
            New-LocalUser -Name $userName -Password $securePass -AccountNeverExpires -FullName "RDP User" -Description "RDP account for GitHub Action" -ErrorAction Stop
            Write-Host "Created user via New-LocalUser."
          } catch {
            Write-Warning "New-LocalUser failed: $_. Trying net user fallback..."
            if (-not $passwordPlain) { $passwordPlain = "RdpTemp2025!" }
            net user $userName $passwordPlain /add > $null 2>&1
            if ($LASTEXITCODE -eq 0) { Write-Host "Created user via net user fallback." } else { Write-Warning "net user fallback failed (exit $LASTEXITCODE)." }
          }
        }

        if (-not $passwordPlain) {
          # if user existed, we can't read its password â€” indicate placeholder
          $passwordPlain = "<existing-user-password>"
        }

        # add to Administrators and Remote Desktop Users (be tolerant)
        try { Add-LocalGroupMember -Group "Administrators" -Member $userName -ErrorAction SilentlyContinue } catch { net localgroup administrators $userName /add > $null 2>&1 }
        try { Add-LocalGroupMember -Group "Remote Desktop Users" -Member $userName -ErrorAction SilentlyContinue } catch { net localgroup "Remote Desktop Users" $userName /add > $null 2>&1 }

        # expose credentials to later steps
        Add-Content -Path $env:GITHUB_ENV -Value "RDP_USER=$userName"
        Add-Content -Path $env:GITHUB_ENV -Value "RDP_PASS=$passwordPlain"

        Write-Host "User step completed."

    - name: Install Tailscale (try MSI then curl fallback)
      shell: powershell
      run: |
        Write-Host "--- Install Tailscale (MSI) ---"
        $url = "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi"
        $msi = Join-Path $env:TEMP "tailscale.msi"

        $downloaded = $false
        try {
          Invoke-WebRequest -Uri $url -OutFile $msi -UseBasicParsing -TimeoutSec 300
          $downloaded = Test-Path $msi
        } catch {
          Write-Warning "Invoke-WebRequest failed: $_"
        }

        if (-not $downloaded) {
          Write-Host "Attempting download via curl..."
          try {
            curl -L $url -o $msi
            $downloaded = Test-Path $msi
          } catch {
            Write-Warning "curl download failed: $_"
          }
        }

        if (-not $downloaded) {
          Write-Error "Failed to download Tailscale MSI. Exiting install step."
          exit 1
        }

        Write-Host "Installing MSI..."
        Start-Process msiexec.exe -ArgumentList "/i", "`"$msi`"", "/quiet", "/norestart" -Wait
        Remove-Item $msi -Force -ErrorAction SilentlyContinue
        Write-Host "Tailscale installation finished."

    - name: Establish Tailscale connection (use secret)
      shell: powershell
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "--- Bring up Tailscale ---"
        $exe = Join-Path $env:ProgramFiles "Tailscale\tailscale.exe"
        if (-not (Test-Path $exe)) {
          Write-Error "Tailscale executable not found at $exe"
          exit 1
        }

        # run tailscale up with provided authkey and a stable hostname
        & $exe up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=MyRDP --accept-dns=false

        # wait for IP assignment
        $ip = $null
        $tries = 0
        while (-not $ip -and $tries -lt 12) {
          Start-Sleep -Seconds 5
          $ip = (& $exe ip -4) -join " "
          $tries++
        }

        if (-not $ip) {
          Write-Error "Tailscale IP not assigned."
          exit 1
        }

        Write-Host "Assigned Tailscale IP: $ip"
        Add-Content -Path $env:GITHUB_ENV -Value "TAILSCALE_IP=$ip"

    - name: Verify RDP accessibility
      shell: powershell
      run: |
        Write-Host "Testing TCP connectivity to $env:TAILSCALE_IP:3389 ..."
        $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
        if ($test -and $test.TcpTestSucceeded) {
          Write-Host "TCP connectivity to RDP port is successful."
        } else {
          Write-Warning "TCP connectivity test failed or timed out. The machine may still be reachable via Tailscale."
        }

    - name: Maintain connection + print credentials
      shell: powershell
      run: |
        Write-Host "=== RDP ACCESS ==="
        Write-Host "Tailscale IP: $env:TAILSCALE_IP"
        Write-Host "Username: $env:RDP_USER"
        Write-Host "Password: $env:RDP_PASS"
        Write-Host "=================="

        # keep runner alive until cancelled or job timeout
        while ($true) {
          Write-Host "[$(Get-Date -Format o)] RDP Active - cancel workflow to stop."
          Start-Sleep -Seconds 300
        }
