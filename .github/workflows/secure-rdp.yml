name: Secure RDP via Tailscale

# Trigger manually from the 'Actions' tab
on: workflow_dispatch

jobs:
  rdp-job:
    runs-on: windows-latest
    timeout-minutes: 360 # 6-hour maximum runtime

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup RDP and Run Tailscale
        shell: powershell
        env:
          # This pulls the secret you created in GitHub repository settings
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}

        run: |
          # --- 1. Enable RDP ---
          Write-Host "Enabling RDP..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # --- 2. Create or Verify RDP User ---
          Write-Host "Setting up RDP user..."
          # Define a complex password
          $password = "P@ssw0rd_Runner_12345!"
          $username = "rdp_user"
          
          try {
            # Try creating the user
            New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -FullName "RDP User" -Description "Temp user for RDP" -ErrorAction Stop
            Write-Host "User '$username' created successfully."
          } catch [Microsoft.ActiveDirectory.LocalAccounts.UserExistsException] {
            # User already exists, just set the password
            Write-Host "User '$username' already exists. Setting password..."
            $user = Get-LocalUser -Name $username
            $user | Set-LocalUser -Password (ConvertTo-SecureString $password -AsPlainText -Force)
          } catch {
            # Other error
            Write-Host "Error creating user: $_.Exception.Message"
            exit 1
          }
          
          # Add user to Remote Desktop Users group
          Write-Host "Adding user to RDP group..."
          net localgroup "Remote Desktop Users" $username /add
          net localgroup "Administrators" $username /add # Optional: give admin rights

          # --- 3. Install Tailscale via Winget (THE NEW, CORRECT METHOD) ---
          Write-Host "Installing Tailscale using Winget..."
          # This command finds the latest stable Tailscale, accepts all agreements, and installs it silently.
          # This replaces the need for manual Download (Step 3) and Install (Step 4).
          winget install --id=Tailscale.Tailscale --source=winget --accept-package-agreements --accept-source-agreements --silent
          
          Write-Host "Tailscale installation completed via Winget."

          # --- 4. Run Tailscale and Connect ---
          Write-Host "Starting Tailscale service..."
          # Ensure the service is running after install
          Start-Service -Name Tailscale -ErrorAction SilentlyContinue
          
          # Add Tailscale directory to the PATH for this session
          # Winget usually does this, but this is a good safety measure.
          $env:PATH += ";C:\Program Files\Tailscale"
          
          Write-Host "Running 'tailscale up'..."
          # Connect to Tailscale
          tailscale up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=github-rdp-runner --accept-routes
          
          Write-Host "Getting Tailscale IP..."
          $tsIp = tailscale ip -4
          Write-Host "Tailscale IP: $tsIp"

          # --- 5. Print Credentials and Keep Alive ---
          Write-Host "--- RDP Connection Details ---"
          Write-Host "Computer (Tailscale IP): $tsIp"
          Write-Host "Username: $username"
          Write-Host "Password: $password"
          Write-Host "-------------------------------"
          
          Write-Host "Workflow is running. Keeping alive (max 6 hours)..."
          # Keepalive loop
          for ($i = 0; $i -lt 360; $i++) {
              Write-Host "Still alive... ($i minutes)"
              Start-Sleep -Seconds 60
          }
          Write-Host "Workflow complete."
