# secure-rdp.yml
name: secure-rdp

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # run every 6 hours

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    - name: Setup RDP user and enable RDP
      shell: powershell
      run: |
        Write-Host "=== Create or ensure RDP user exists ==="
        try {
          $exists = & net user RDP 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "User RDP already exists (checked with net user)."
          } else {
            Write-Host "Creating user RDP using net user..."
            # strong password example - you can change it
            $pass = "RdpP@ssw0rd2025!"
            net user RDP $pass /add
            if ($LASTEXITCODE -ne 0) { throw "net user failed to create RDP (exit $LASTEXITCODE)." }
            net localgroup administrators RDP /add
            Write-Host "User created and added to Administrators."
          }

          Write-Host "Enabling Remote Desktop settings..."
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          Write-Host "Remote Desktop enabled."
        } catch {
          Write-Error "Failed to create user or enable RDP: $_"
          exit 1
        }

    - name: Install and connect Tailscale
      shell: powershell
      run: |
        Write-Host "Installing Tailscale..."
        iwr https://tailscale.com/install.ps1 -UseBasicParsing | iex
        Write-Host "Bringing Tailscale up..."
        tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname "MyRDP" --accept-dns=false
        Write-Host "Getting Tailscale IPv4..."
        $ip = tailscale ip -4
        if ($ip) { Write-Host "Tailscale IP (IPv4): $ip" } else { Write-Host "Warning: no IPv4 returned by tailscale ip." }

    - name: Keep session alive
      shell: powershell
      run: |
        Write-Host "Keeping session alive for 6 hours."
        Start-Sleep -Seconds 21600
